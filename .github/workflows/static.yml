# Deploy ONB Mod Analyzer to GitHub Pages
name: Deploy to Pages

on:
  # Runs on pushes targeting the default branch (deploys existing files)
  push:
    branches: ["master"]

  # Allows you to manually trigger a new WASM build and deployment
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          ssh-key: ${{ secrets.SUBMODULE_DEPLOY_KEY }}
      
      - name: Check version and decide whether to build
        id: version_check
        run: |
          # Extract version from pubspec.yaml in the Dart tool submodule
          PUBSPEC_VERSION=$(grep '^version:' src/DartLangModTool-master/pubspec.yaml | sed 's/version: *//' | tr -d '\r\n')
          
          if [ -z "$PUBSPEC_VERSION" ]; then
            echo "Error: Could not extract version from pubspec.yaml"
            exit 1
          fi
          
          if ! echo "$PUBSPEC_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "Error: Version must be in semver format (e.g., 1.2.3), got: $PUBSPEC_VERSION"
            exit 1
          fi
          
          echo "Pubspec version: $PUBSPEC_VERSION"
          
          # Get latest version from index.json if it exists
          if [ -f src/web/versions/index.json ]; then
            LATEST_VERSION=$(jq -r 'map(select(.latest == true)) | .[0].version // "v0.0.0"' src/web/versions/index.json | sed 's/^v//')
            echo "Latest built version: $LATEST_VERSION"
          else
            LATEST_VERSION="0.0.0"
            echo "No index.json found, will build first version"
          fi
          
          # Compare versions using sort -V (version sort)
          SHOULD_BUILD="false"
          if [ "$PUBSPEC_VERSION" != "$LATEST_VERSION" ]; then
            HIGHER=$(printf "%s\n%s" "$PUBSPEC_VERSION" "$LATEST_VERSION" | sort -V | tail -n1)
            if [ "$HIGHER" = "$PUBSPEC_VERSION" ]; then
              SHOULD_BUILD="true"
              echo "✓ New version detected: $PUBSPEC_VERSION > $LATEST_VERSION"
            else
              echo "✗ Pubspec version ($PUBSPEC_VERSION) is not higher than latest ($LATEST_VERSION)"
            fi
          else
            echo "✗ Versions match, no build needed"
          fi
          
          # Override: always build on manual workflow_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SHOULD_BUILD="true"
            echo "⚠ Manual trigger: forcing build regardless of version"
          fi
          
          echo "should_build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "VERSION=$PUBSPEC_VERSION" >> $GITHUB_ENV
      
      - name: Install mise
        if: steps.version_check.outputs.should_build == 'true'
        uses: jdx/mise-action@v2
        with:
          install: true
          cache: true
      
      - name: Build WASM module
        if: steps.version_check.outputs.should_build == 'true'
        run: |
          cd src
          mise run build:web
      
      - name: Get version from pubspec.yaml
        if: steps.version_check.outputs.should_build == 'true'
        run: |
          # Extract version from pubspec.yaml in the Dart tool submodule
          VERSION=$(grep '^version:' src/DartLangModTool-master/pubspec.yaml | sed 's/version: *//' | tr -d '\r\n')
          
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from pubspec.yaml"
            exit 1
          fi
          
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "Error: Version must be in semver format (e.g., 1.2.3), got: $VERSION"
            exit 1
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"
      
      - name: Build WASM module
        if: github.event_name == 'workflow_dispatch'
        run: |
          cd src
          mise run build:web
      
      - name: Verify build artifacts
        if: steps.version_check.outputs.should_build == 'true'
        run: |
          cd src
          if [ ! -f web/versions/latest/onb_mod_file.wasm ]; then
            echo "Error: WASM file not found"
            exit 1
          fi
          if [ ! -f web/versions/latest/onb_mod_file.mjs ]; then
            echo "Error: MJS file not found"
            exit 1
          fi
          
          # Check file sizes
          WASM_SIZE=$(stat -c%s web/versions/latest/onb_mod_file.wasm)
          echo "WASM size: $WASM_SIZE bytes"
          
          if [ $WASM_SIZE -lt 1000 ]; then
            echo "Error: WASM file is suspiciously small"
            exit 1
          fi
      
      - name: Create versioned directory
        if: steps.version_check.outputs.should_build == 'true'
        run: |
          cd src/web/versions
          
          # Remove existing version directory if it exists
          if [ -d "v$VERSION" ]; then
            echo "Version v$VERSION already exists, overwriting..."
            rm -rf "v$VERSION"
          fi
          
          # Create version directory
          mkdir -p "v$VERSION"
          
          # Copy artifacts from latest (which was just built by mise)
          cp latest/onb_mod_file.wasm "v$VERSION/"
          cp latest/onb_mod_file.mjs "v$VERSION/"
          cp latest/metadata.json "v$VERSION/"
          
          # Update metadata with correct version
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" "v$VERSION/metadata.json"
          
          # Update latest metadata too
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" latest/metadata.json
      
      - name: Update version index
        if: steps.version_check.outputs.should_build == 'true'
        run: |
          cd src/web/versions
          
          # Read existing index
          if [ -f index.json ]; then
            INDEX_CONTENT=$(cat index.json)
          else
            INDEX_CONTENT="[]"
          fi
          
          # Create new version entry
          NEW_VERSION=$(cat <<EOF
          {
            "version": "v$VERSION",
            "latest": true,
            "buildDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "features": [
              "mod-analysis",
              "lua-parsing",
              "json-output"
            ],
            "description": "Production release v$VERSION"
          }
          EOF
          )
          
          # Use jq to remove any existing entry for this version, mark all as not latest, then add new as latest
          echo "$INDEX_CONTENT" | jq --arg ver "v$VERSION" --argjson new "$NEW_VERSION" \
            'map(select(.version != $ver)) | map(.latest = false) + [$new] | sort_by(.version) | reverse' \
            > index.json
          
          cat index.json
      
      - name: Commit new version
        if: steps.version_check.outputs.should_build == 'true'
        run: |
          # Configure git to use HTTPS with token instead of SSH
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Prevent git from trying to push submodule changes
          git config push.recurseSubmodules no
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add src/web/versions/
          git commit -m "Build and release v$VERSION"
          git push
      
      - name: Generate build summary
        if: steps.version_check.outputs.should_build == 'true'
        run: |
          cd src
          WASM_SIZE=$(stat -c%s web/versions/latest/onb_mod_file.wasm | numfmt --to=iec-i --suffix=B)
          MJS_SIZE=$(stat -c%s web/versions/latest/onb_mod_file.mjs | numfmt --to=iec-i --suffix=B)
          
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # Build Summary
          
          ## Version: $VERSION
          
          ### Artifacts
          - **WASM**: $WASM_SIZE
          - **MJS**: $MJS_SIZE
          
          ### Build Info
          - **Date**: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)
          - **Commit**: ${{ github.sha }}
          - **Workflow**: ${{ github.workflow }}
          
          ### Deployment
          The analyzer will be available at:
          \`https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/\`
          EOF
      
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: src/web
  
  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Verify deployment
        run: |
          sleep 10
          
          URL="${{ steps.deployment.outputs.page_url }}"
          echo "Checking deployment at: $URL"
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          
          if [ "$STATUS" -eq 200 ]; then
            echo "✓ Deployment successful!"
          else
            echo "⚠ Deployment returned status: $STATUS"
            exit 1
          fi
