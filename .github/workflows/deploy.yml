name: Deploy ONB Mod Analyzer to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.3)'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Setup Cachix
        uses: cachix/cachix-action@v13
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true
      
      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: Version must be in semver format (e.g., 1.2.3)"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      
      - name: Build WASM module
        run: |
          cd src
          nix build .#wasm -o result-wasm
      
      - name: Verify build artifacts
        run: |
          cd src
          if [ ! -f result-wasm/onb_mod_file.wasm ]; then
            echo "Error: WASM file not found"
            exit 1
          fi
          if [ ! -f result-wasm/onb_mod_file.mjs ]; then
            echo "Error: MJS file not found"
            exit 1
          fi
          
          # Check file sizes
          WASM_SIZE=$(stat -c%s result-wasm/onb_mod_file.wasm)
          echo "WASM size: $WASM_SIZE bytes"
          
          if [ $WASM_SIZE -lt 1000 ]; then
            echo "Error: WASM file is suspiciously small"
            exit 1
          fi
      
      - name: Create versioned directory
        run: |
          cd src/web/versions
          
          # Create version directory
          mkdir -p "v$VERSION"
          
          # Copy artifacts
          cp ../result-wasm/onb_mod_file.wasm "v$VERSION/"
          cp ../result-wasm/onb_mod_file.mjs "v$VERSION/"
          cp ../result-wasm/metadata.json "v$VERSION/"
          
          # Update metadata with correct version
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" "v$VERSION/metadata.json"
          
          # Update latest
          rm -rf latest
          cp -r "v$VERSION" latest
      
      - name: Update version index
        run: |
          cd src/web/versions
          
          # Read existing index
          if [ -f index.json ]; then
            INDEX_CONTENT=$(cat index.json)
          else
            INDEX_CONTENT="[]"
          fi
          
          # Add new version
          NEW_VERSION=$(cat <<EOF
          {
            "version": "v$VERSION",
            "latest": true,
            "buildDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "features": [
              "mod-analysis",
              "lua-parsing",
              "json-output"
            ],
            "description": "Production release v$VERSION"
          }
          EOF
          )
          
          # Use jq to update the JSON (mark all as not latest, add new as latest)
          echo "$INDEX_CONTENT" | jq --argjson new "$NEW_VERSION" \
            'map(.latest = false) + [$new] | sort_by(.version) | reverse' \
            > index.json
          
          cat index.json
      
      - name: Generate build summary
        run: |
          cd src
          WASM_SIZE=$(stat -c%s result-wasm/onb_mod_file.wasm | numfmt --to=iec-i --suffix=B)
          MJS_SIZE=$(stat -c%s result-wasm/onb_mod_file.mjs | numfmt --to=iec-i --suffix=B)
          
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # Build Summary
          
          ## Version: $VERSION
          
          ### Artifacts
          - **WASM**: $WASM_SIZE
          - **MJS**: $MJS_SIZE
          
          ### Build Info
          - **Date**: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)
          - **Commit**: ${{ github.sha }}
          - **Workflow**: ${{ github.workflow }}
          
          ### Deployment
          The analyzer will be available at:
          \`https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/\`
          EOF
      
      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: src/web
  
  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Verify deployment
        run: |
          sleep 10
          
          URL="${{ steps.deployment.outputs.page_url }}"
          echo "Checking deployment at: $URL"
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          
          if [ "$STATUS" -eq 200 ]; then
            echo "âœ“ Deployment successful!"
          else
            echo "âš  Deployment returned status: $STATUS"
            exit 1
          fi
      
      - name: Post deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # Deployment Complete
          
          ðŸš€ **ONB Mod Analyzer v${{ github.event.inputs.version }}** has been deployed!
          
          **Live URL**: ${{ steps.deployment.outputs.page_url }}
          
          ### Next Steps
          1. Visit the URL to verify the deployment
          2. Test analyzer functionality with sample mods
          3. Update documentation if needed
          EOF
